<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <meta
            http-equiv="Content-Security-Policy"
            content="upgrade-insecure-requests"
        />

        <title>Post Update Form</title>
        <meta content="" name="description" />
        <meta content="" name="keywords" />

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon" />
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
            rel="stylesheet"
        />

        <!-- Vendor CSS Files -->
        <link
            href="assets/vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/fontawesome-free/css/all.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/glightbox/css/glightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/swiper/swiper-bundle.min.css"
            rel="stylesheet"
        />
        <link href="assets/vendor/aos/aos.css" rel="stylesheet" />

        <!-- Template Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet" />

        <style>
            .form-control:focus {
                background-color: #ffffe0; /* 옅은 노란색 */
                border-color: #ced4da;
                box-shadow: none;
            }
            .form-control {
                background-color: #ffffe0; /* 옅은 노란색 */
                color: #495057;
            }
            .form-label {
                color: #6c757d; /* 회색 */
            }
            #InputContent {
                resize: none;
            }
        </style>

        <!-- =======================================================
  * Template Name: Logis
  * Template URL: https://bootstrapmade.com/logis-bootstrap-logistics-website-template/
  * Updated: Mar 17 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
    </head>
    <body>
        <header id="header" class="header d-flex align-items-center fixed-top">
            <div
                class="container-fluid container-xl d-flex align-items-center justify-content-between"
            >
                <a href="index.html" class="logo d-flex align-items-center">
                    <!-- Uncomment the line below if you also wish to use an image logo -->
                    <!-- <img src="assets/img/logo.png" alt=""> -->
                    <h1>Logis</h1>
                </a>

                <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
                <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
                <nav id="navbar" class="navbar">
                    <ul>
                        <li><a href="about.html">About</a></li>
                        <li><a href="services.html">Services</a></li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><span class="user-name"></span></li>
                        <li>
                            <a href="#" class="LoginBtn">Login</a>
                        </li>
                        <li><a href="#" id="userNameDisplay"></a></li>
                        <li><a href="#" class="LogoutBtn">Logout</a></li>
                    </ul>
                </nav>
                <!-- .navbar -->
            </div>
        </header>
        <!-- End Header -->
        <!-- End Header -->

        <main id="main">
            <!-- ======= Breadcrumbs ======= -->
            <div class="breadcrumbs">
                <div
                    class="page-header d-flex align-items-center"
                    style="background-image: url('assets/img/page-header.jpg')"
                >
                    <div class="container position-relative">
                        <div class="row d-flex justify-content-center">
                            <div class="col-lg-6 text-center">
                                <h2>Update Post</h2>
                                <p>
                                    Odio et unde deleniti. Deserunt numquam
                                    exercitationem. Officiis quo odio sint
                                    voluptas consequatur ut a odio voluptatem.
                                    Sit dolorum debitis veritatis natus dolores.
                                    Quasi ratione sint. Sit quaerat ipsum
                                    dolorem.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <nav>
                    <div class="container">
                        <ol>
                            <li><a href="index.html">Home</a></li>
                            <li>Update Post</li>
                        </ol>
                    </div>
                </nav>
            </div>
            <!-- End Breadcrumbs -->

            <!-- ======= Post Create Section ======= -->
            <section id="pricing" class="pricing">
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="post-form-container border p-5">
                                <h2 class="mb-4">포스트 수정</h2>
                                <form
                                    method="POST"
                                    enctype="multipart/form-data"
                                    id="postForm"
                                >
                                    <div class="mb-3">
                                        <label
                                            for="InputTitle"
                                            class="form-label"
                                            >제목</label
                                        >
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="InputTitle"
                                            name="title"
                                            required
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="InputCategory"
                                            class="form-label"
                                            >카테고리</label
                                        >
                                        <select
                                            class="form-control"
                                            id="InputCategory"
                                            name="category"
                                            required
                                        ></select>
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="InputContent"
                                            class="form-label"
                                            >내용</label
                                        >
                                        <textarea
                                            class="form-control"
                                            id="InputContent"
                                            name="content"
                                            rows="3"
                                            required
                                        ></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="InputImage"
                                            class="form-label"
                                            >이미지 업로드</label
                                        >
                                        <input
                                            type="file"
                                            class="form-control"
                                            id="InputImage"
                                            name="image"
                                            accept="image/*"
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="InputFile"
                                            class="form-label"
                                            >파일 업로드</label
                                        >
                                        <input
                                            type="file"
                                            class="form-control"
                                            id="InputFile"
                                            name="file_upload"
                                            accept=".pdf,.doc,.docx"
                                        />
                                    </div>
                                    <div class="d-grid gap-2">
                                        <input
                                            type="submit"
                                            class="btn btn-primary"
                                            value="포스트 수정"
                                        />
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <!-- End #main -->
        <!-- ======= Footer ======= -->
        <footer id="footer" class="footer">
            <div class="container">
                <div class="row gy-4">
                    <div class="col-lg-5 col-md-12 footer-info">
                        <a
                            href="index.html"
                            class="logo d-flex align-items-center"
                        >
                            <span>Logis</span>
                        </a>
                        <p>
                            Cras fermentum odio eu feugiat lide par naso tierra.
                            Justo eget nada terra videa magna derita valies
                            darta donna mare fermentum iaculis eu non diam
                            phasellus.
                        </p>
                        <div class="social-links d-flex mt-4">
                            <a href="#" class="twitter"
                                ><i class="bi bi-twitter"></i
                            ></a>
                            <a href="#" class="facebook"
                                ><i class="bi bi-facebook"></i
                            ></a>
                            <a href="#" class="instagram"
                                ><i class="bi bi-instagram"></i
                            ></a>
                            <a href="#" class="linkedin"
                                ><i class="bi bi-linkedin"></i
                            ></a>
                        </div>
                    </div>

                    <div class="col-lg-2 col-6 footer-links">
                        <h4>Useful Links</h4>
                        <ul>
                            <li><a href="#">Home</a></li>
                            <li><a href="#">About us</a></li>
                            <li><a href="#">Services</a></li>
                            <li><a href="#">Terms of service</a></li>
                            <li><a href="#">Privacy policy</a></li>
                        </ul>
                    </div>

                    <div class="col-lg-2 col-6 footer-links">
                        <h4>Our Services</h4>
                        <ul>
                            <li><a href="#">Web Design</a></li>
                            <li><a href="#">Web Development</a></li>
                            <li><a href="#">Product Management</a></li>
                            <li><a href="#">Marketing</a></li>
                            <li><a href="#">Graphic Design</a></li>
                        </ul>
                    </div>

                    <div
                        class="col-lg-3 col-md-12 footer-contact text-center text-md-start"
                    >
                        <h4>Contact Us</h4>
                        <p>
                            A108 Adam Street <br />
                            New York, NY 535022<br />
                            United States <br /><br />
                            <strong>Phone:</strong> +1 5589 55488 55<br />
                            <strong>Email:</strong> info@example.com<br />
                        </p>
                    </div>
                </div>
            </div>

            <div class="container mt-4">
                <div class="copyright">
                    &copy; Copyright <strong><span>Logis</span></strong
                    >. All Rights Reserved
                </div>
                <div class="credits">
                    <!-- All the links in the footer should remain intact. -->
                    <!-- You can delete the links only if you purchased the pro version. -->
                    <!-- Licensing information: https://bootstrapmade.com/license/ -->
                    <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/logis-bootstrap-logistics-website-template/ -->
                    Designed by
                    <a href="https://bootstrapmade.com/">BootstrapMade</a>
                </div>
            </div>
        </footer>
        <!-- End Footer -->

        <a
            href="#"
            class="scroll-top d-flex align-items-center justify-content-center"
            ><i class="bi bi-arrow-up-short"></i>
        </a>

        <div id="preloader"></div>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>

        <!-- Template Main JS File -->
        <script src="assets/js/main.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const access = localStorage.getItem('access');
                const loginBtnEl = document.querySelector('.LoginBtn');
                const logoutBtnEl = document.querySelector('.LogoutBtn');
                const userNameDisplayEl =
                    document.querySelector('#userNameDisplay');
                const postForm = document.getElementById('postForm');
                const isAuthenticated = !!access;

                if (isAuthenticated) {
                    // 토큰 갱신
                    fetch('http://127.0.0.1:8000/api/token/refresh/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            refresh: localStorage.getItem('refresh'),
                        }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            const { access: newToken } = data;
                            localStorage.setItem('access', newToken);

                            // 사용자 이름 가져오기
                            fetch(
                                'http://127.0.0.1:8000/api/accounts/profile/',
                                {
                                    headers: {
                                        Authorization: `Bearer ${newToken}`,
                                    },
                                }
                            )
                                .then((response) => response.json())
                                .then((userData) => {
                                    if (userNameDisplayEl) {
                                        userNameDisplayEl.textContent =
                                            userData.username;
                                    }
                                    if (loginBtnEl) {
                                        loginBtnEl.style.display = 'none';
                                        loginBtnEl.textContent =
                                            userData.username;
                                    }
                                })
                                .catch((error) => {
                                    console.error(
                                        'Error fetching username:',
                                        error
                                    );
                                });

                            if (logoutBtnEl) {
                                logoutBtnEl.style.display = 'block';
                                logoutBtnEl.addEventListener('click', () => {
                                    // 로컬 스토리지에서 인증 토큰 삭제
                                    localStorage.removeItem('access');
                                    localStorage.removeItem('refresh');
                                    // index.html로 리다이렉트
                                    location.href = 'index.html';
                                });
                            }
                        })
                        .catch((error) => {
                            console.error('Error refreshing token:', error);
                        });

                    // URL에서 postId 값을 가져오는 함수
                    function getPostIdFromUrl() {
                        const queryParams = new URLSearchParams(
                            window.location.search
                        );
                        return queryParams.get('postId');
                    }

                    // postId를 사용하여 게시물의 세부 정보를 가져오는 함수
                    function fetchPostDetails(postId) {
                        fetch(`http://127.0.0.1:8000/api/posts/${postId}/`, {
                            headers: {
                                Authorization: `Bearer ${localStorage.getItem(
                                    'access'
                                )}`,
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                fillPostDetailsForm(data);
                            })
                            .catch((error) => {
                                console.error(
                                    'Error fetching post details:',
                                    error
                                );
                            });
                    }

                    // 가져온 게시물의 세부 정보를 폼에 채우는 함수
                    function fillPostDetailsForm(post) {
                        document.getElementById('InputTitle').value =
                            post.title;
                        document.getElementById('InputContent').value =
                            post.content;
                        document.getElementById('InputCategory').value =
                            post.category.id;
                        // 이미지와 파일 필드도 채워주어야 할 경우 추가 로직 필요
                    }

                    const postId = getPostIdFromUrl();
                    if (postId) {
                        fetchPostDetails(postId);
                    }

                    // 카테고리 목록 가져오기
                    fetch('http://127.0.0.1:8000/api/posts/categories/', {
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem(
                                'access'
                            )}`,
                        },
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then((data) => {
                            const categories = data || [];
                            console.log('카테고리데이터:', categories);
                            const categorySelect =
                                document.getElementById('InputCategory');
                            categories.forEach((category) => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.text = category.name;
                                categorySelect.add(option);
                            });
                        })
                        .catch((error) => {
                            console.error('Error fetching categories:', error);
                        });

                    const postForm = document.getElementById('postForm');

                    postForm.addEventListener('submit', function (e) {
                        e.preventDefault();

                        const postId = getPostIdFromUrl();
                        if (!postId) {
                            alert('유효한 접근이 아닙니다.');
                            return;
                        }

                        const formData = new FormData(postForm);
                        const categorySelect =
                            document.getElementById('InputCategory');
                        const selectedCategoryId = categorySelect.value;
                        formData.append('category', selectedCategoryId);

                        fetch(
                            `http://127.0.0.1:8000/api/posts/${postId}/update/`,
                            {
                                method: 'PATCH',
                                headers: {
                                    Authorization: `Bearer ${localStorage.getItem(
                                        'access'
                                    )}`,
                                },
                                body: formData,
                            }
                        )
                            .then((response) => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error('Network response was not ok.');
                            })
                            .then((data) => {
                                console.log(data);
                                location.href = 'services.html';
                            })
                            .catch((error) => {
                                console.error(
                                    'There has been a problem with your fetch operation:',
                                    error
                                );
                            });
                    });
                } else {
                    // 로그인 되어 있지 않은 경우
                    if (loginBtnEl) {
                        loginBtnEl.style.display = 'block';
                        // 로그인 버튼에 이벤트 리스너 추가
                        loginBtnEl.addEventListener('click', () => {
                            // login.html로 리다이렉트
                            location.href = 'login.html';
                        });
                    }
                    if (logoutBtnEl) {
                        logoutBtnEl.style.display = 'none';
                    }
                }
            });
        </script>
    </body>
</html>
