<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />

        <title>Logis Bootstrap Template - Service Details</title>
        <meta content="" name="description" />
        <meta content="" name="keywords" />

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon" />
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
            rel="stylesheet"
        />

        <!-- Vendor CSS Files -->
        <link
            href="assets/vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/fontawesome-free/css/all.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/glightbox/css/glightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/swiper/swiper-bundle.min.css"
            rel="stylesheet"
        />
        <link href="assets/vendor/aos/aos.css" rel="stylesheet" />

        <!-- Template Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet" />

        <style>
            #comment {
                overflow: auto; /* 스크롤바를 추가하여 내용이 넘칠 때 스크롤 가능하게 함 */
            }
            #comment::placeholder {
                color: grey;
            }
        </style>

        <!-- =======================================================
  * Template Name: Logis
  * Template URL: https://bootstrapmade.com/logis-bootstrap-logistics-website-template/
  * Updated: Mar 17 2024 with Bootstrap v5.3.3
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
    </head>

    <body>
        <!-- ======= Header ======= -->
        <header id="header" class="header d-flex align-items-center fixed-top">
            <div
                class="container-fluid container-xl d-flex align-items-center justify-content-between"
            >
                <a href="index.html" class="logo d-flex align-items-center">
                    <!-- Uncomment the line below if you also wish to use an image logo -->
                    <!-- <img src="assets/img/logo.png" alt=""> -->
                    <h1>Logis</h1>
                </a>

                <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
                <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
                <nav id="navbar" class="navbar">
                    <ul>
                        <li><a href="about.html">About</a></li>
                        <li>
                            <a href="services.html">Services</a>
                        </li>
                        <li><a href="pricing.html">Pricing</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><span class="user-name"></span></li>
                        <li>
                            <a href="#" class="LoginBtn">Login</a>
                        </li>
                        <li><a href="#" id="userNameDisplay"></a></li>
                        <li><a href="#" class="LogoutBtn">Logout</a></li>
                    </ul>
                </nav>
                <!-- .navbar -->
            </div>
        </header>
        <!-- End Header -->

        <main id="main">
            <!-- ======= Breadcrumbs ======= -->
            <div class="breadcrumbs">
                <div
                    class="page-header d-flex align-items-center"
                    style="background-image: url('assets/img/page-header.jpg')"
                >
                    <div class="container position-relative">
                        <div class="row d-flex justify-content-center">
                            <div class="col-lg-6 text-center">
                                <h2>Service Details</h2>
                                <p>
                                    Odio et unde deleniti. Deserunt numquam
                                    exercitationem. Officiis quo odio sint
                                    voluptas consequatur ut a odio voluptatem.
                                    Sit dolorum debitis veritatis natus dolores.
                                    Quasi ratione sint. Sit quaerat ipsum
                                    dolorem.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <nav>
                    <div class="container">
                        <ol>
                            <li><a href="index.html">Home</a></li>
                            <li>Service Details</li>
                        </ol>
                    </div>
                </nav>
            </div>
            <!-- End Breadcrumbs -->

            <!-- ======= Service Details Section ======= -->
            <section id="service-details" class="service-details">
                <div class="container" data-aos="fade-up">
                    <div class="row gy-4">
                        <div class="col-lg-4">
                            <div class="services-list">
                                <a href="#" class="active">Storage</a>
                                <a href="#">Logistics</a>
                                <a href="#">Cargo</a>
                                <a href="#">Trucking</a>
                                <a href="#">Packaging</a>
                                <a href="#">Warehousing</a>
                            </div>

                            <h4>Enim qui eos rerum in delectus</h4>
                            <p>
                                Nam voluptatem quasi numquam quas fugiat ex
                                temporibus quo est. Quia aut quam quod facere ut
                                non occaecati ut aut. Nesciunt mollitia illum
                                tempore corrupti sed eum reiciendis. Maxime modi
                                rerum.
                            </p>
                        </div>

                        <div class="col-lg-8">
                            <img />
                            <h4 class="mt-4" id="category">카테고리</h4>
                            <h3 class="mt-4" id="title">제목</h3>
                            <button
                                class="btn btn-danger float-end"
                                id="delete-post-btn"
                            >
                                삭제
                            </button>
                            <button
                                class="btn btn-primary float-end me-1"
                                id="edit-post-btn"
                            >
                                수정
                            </button>
                            <p id="author">작성자</p>
                            <p id="view-count">조회수</p>

                            <p id="content">본문</p>

                            <!-- 좋아요, 스크랩, 공유 버튼 -->
                            <div class="my-4">
                                <button
                                    class="btn btn-outline-primary me-2"
                                    id="like-btn"
                                    style="text-decoration: none"
                                >
                                    좋아요
                                </button>
                                <span id="like-count">0</span>
                                <button
                                    class="btn btn-outline-success float-end"
                                    id="scrap-btn"
                                >
                                    스크랩
                                </button>
                                <button
                                    class="btn btn-outline-info float-end me-4"
                                    id="share-btn"
                                >
                                    공유
                                </button>
                            </div>

                            <hr class="my-4" />

                            <div class="my-5">
                                <form id="commentForm">
                                    <div class="form-group">
                                        <textarea
                                            class="form-control"
                                            id="comment"
                                            rows="3"
                                            placeholder="방금 읽은 콘텐츠 어떠셨나요? 자유롭게 의견을 남겨주세요."
                                            style="resize: none"
                                        ></textarea>
                                    </div>
                                    <button
                                        type="submit"
                                        class="btn btn-primary float-end mt-3"
                                    >
                                        작성하기
                                    </button>
                                </form>
                            </div>
                            <div id="commentsList" class="mt-5">댓글리스트</div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- End Service Details Section -->
        </main>
        <!-- End #main -->

        <!-- ======= Footer ======= -->
        <footer id="footer" class="footer">
            <div class="container">
                <div class="row gy-4">
                    <div class="col-lg-5 col-md-12 footer-info">
                        <a
                            href="index.html"
                            class="logo d-flex align-items-center"
                        >
                            <span>Logis</span>
                        </a>
                        <p>
                            Cras fermentum odio eu feugiat lide par naso tierra.
                            Justo eget nada terra videa magna derita valies
                            darta donna mare fermentum iaculis eu non diam
                            phasellus.
                        </p>
                        <div class="social-links d-flex mt-4">
                            <a href="#" class="twitter"
                                ><i class="bi bi-twitter"></i
                            ></a>
                            <a href="#" class="facebook"
                                ><i class="bi bi-facebook"></i
                            ></a>
                            <a href="#" class="instagram"
                                ><i class="bi bi-instagram"></i
                            ></a>
                            <a href="#" class="linkedin"
                                ><i class="bi bi-linkedin"></i
                            ></a>
                        </div>
                    </div>

                    <div class="col-lg-2 col-6 footer-links">
                        <h4>Useful Links</h4>
                        <ul>
                            <li><a href="#">Home</a></li>
                            <li><a href="#">About us</a></li>
                            <li><a href="#">Services</a></li>
                            <li><a href="#">Terms of service</a></li>
                            <li><a href="#">Privacy policy</a></li>
                        </ul>
                    </div>

                    <div class="col-lg-2 col-6 footer-links">
                        <h4>Our Services</h4>
                        <ul>
                            <li><a href="#">Web Design</a></li>
                            <li><a href="#">Web Development</a></li>
                            <li><a href="#">Product Management</a></li>
                            <li><a href="#">Marketing</a></li>
                            <li><a href="#">Graphic Design</a></li>
                        </ul>
                    </div>

                    <div
                        class="col-lg-3 col-md-12 footer-contact text-center text-md-start"
                    >
                        <h4>Contact Us</h4>
                        <p>
                            A108 Adam Street <br />
                            New York, NY 535022<br />
                            United States <br /><br />
                            <strong>Phone:</strong> +1 5589 55488 55<br />
                            <strong>Email:</strong> info@example.com<br />
                        </p>
                    </div>
                </div>
            </div>

            <div class="container mt-4">
                <div class="copyright">
                    &copy; Copyright <strong><span>Logis</span></strong
                    >. All Rights Reserved
                </div>
                <div class="credits">
                    <!-- All the links in the footer should remain intact. -->
                    <!-- You can delete the links only if you purchased the pro version. -->
                    <!-- Licensing information: https://bootstrapmade.com/license/ -->
                    <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/logis-bootstrap-logistics-website-template/ -->
                    Designed by
                    <a href="https://bootstrapmade.com/">BootstrapMade</a>
                </div>
            </div>
        </footer>
        <!-- End Footer -->
        <!-- End Footer -->

        <a
            href="#"
            class="scroll-top d-flex align-items-center justify-content-center"
            ><i class="bi bi-arrow-up-short"></i
        ></a>

        <div id="preloader"></div>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>

        <!-- Template Main JS File -->
        <script src="assets/js/main.js"></script>
    </body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const access = localStorage.getItem('access');
            const loginBtnEl = document.querySelector('.LoginBtn');
            const logoutBtnEl = document.querySelector('.LogoutBtn');
            const userNameDisplayEl =
                document.querySelector('#userNameDisplay');
            const commentFormEl = document.getElementById('commentForm');
            const commentTextareaEl = document.getElementById('comment');
            const likeBtn = document.getElementById('like-btn');
            const likeCount = document.getElementById('like-count');
            const isAuthenticated = !!access;
            document.querySelector('.col-lg-8 img').style.width = '800px';
            document.querySelector('.col-lg-8 img').style.height = '600px';

            if (isAuthenticated) {
                // 토큰 갱신
                fetch('http://127.0.0.1:8000/api/token/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refresh: localStorage.getItem('refresh'),
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        const { access: newToken } = data;
                        localStorage.getItem('access', newToken);

                        // 사용자 이름 가져오기
                        fetch('http://127.0.0.1:8000/api/accounts/profile/', {
                            headers: {
                                Authorization: `Bearer ${newToken}`,
                            },
                        })
                            .then((response) => response.json())
                            .then((userData) => {
                                if (userNameDisplayEl) {
                                    userNameDisplayEl.textContent =
                                        userData.username;
                                }
                                if (loginBtnEl) {
                                    loginBtnEl.style.display = 'none';
                                    loginBtnEl.textContent = userData.username;
                                }
                            })
                            .catch((error) => {
                                console.error(
                                    'Error fetching username:',
                                    error
                                );
                            });
                    })
                    .catch((error) => {
                        console.error('Error refreshing token:', error);
                    });
                if (logoutBtnEl) {
                    logoutBtnEl.style.display = 'block';
                    logoutBtnEl.addEventListener('click', () => {
                        // 로컬 스토리지에서 인증 토큰 삭제
                        localStorage.removeItem('access');
                        localStorage.removeItem('refresh');
                        // index.html로 리다이렉트
                        location.href = 'index.html';
                    });
                }
                // URL에서 postId 값을 가져오는 함수
                function getPostIdFromUrl() {
                    const queryParams = new URLSearchParams(
                        window.location.search
                    );
                    console.log(queryParams);
                    return queryParams.get('postId');
                }
                // postId를 사용하여 게시물의 세부 정보를 가져오는 함수
                function fetchPostDetails(postId) {
                    fetch(`http://127.0.0.1:8000/api/posts/${postId}/`, {
                        headers: {
                            Authorization: `Bearer ${localStorage.getItem(
                                'access'
                            )}`,
                        },
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            fillPostDetails(data);
                            updateLikeStatus(data.isLiked);
                            updateLikeCount(data.likesCount);
                        })
                        .catch((error) => {
                            console.error(
                                'Error fetching post details:',
                                error
                            );
                            // 오류 발생 시 적절한 처리를 해야 합니다. 예: 사용자에게 오류 메시지를 보여주기
                        });
                    // const postId = post.id;
                    // fetchComments(postId); // 게시물 댓글 목록 가져오기
                }

                // 가져온 게시물의 세부 정보를 페이지에 채우는 함수
                function fillPostDetails(post) {
                    const postImage =
                        post.image || 'https://picsum.photos/800/600'; // 이미지가 없을 경우 더미 이미지 사용
                    document.querySelector('.col-lg-8 img').src = postImage;
                    document.querySelector('#category').textContent =
                        post.category_name || '카테고리 없음';
                    document.querySelector('#title').textContent =
                        post.title || '제목 없음';
                    document.querySelector('#author').textContent =
                        post.author_username || '작성자 정보 없음';
                    document.querySelector(
                        '#view-count'
                    ).textContent = `조회수: ${
                        post.view_count !== null ? post.view_count : '0'
                    }`;
                    document.querySelector('#content').textContent =
                        post.content;
                    // 추가적인 내용 채우기 (예: 작성자, 좋아요 수 등)를 여기에 구현할 수 있습니다.
                }

                function updateLikeStatus(isLiked) {
                    isLiked = isLiked; // 좋아요 상태 업데이트
                }

                function updateLikeCount(likeCount) {
                    const likeCountEl = document.getElementById('like-count');
                    likeCountEl.textContent = likeCount;
                }

                const postId = getPostIdFromUrl();
                if (postId) {
                    fetchPostDetails(postId);
                    fetchComments(postId);
                } else {
                    // postId가 없는 경우의 처리를 해야 합니다. 예: 메인 페이지로 리다이렉트
                    alert('유효한 접근이 아닙니다');
                    location.href = 'services.html';
                }

                // 좋아요 상태를 저장할 변수
                let isLiked = false;

                // 좋아요 버튼 클릭 이벤트 리스너
                likeBtn.addEventListener('click', () => {
                    const postId = getPostIdFromUrl();
                    if (postId) {
                        if (isLiked) {
                            // 이미 좋아요 상태인 경우, 좋아요 취소
                            unlikePost(postId);
                        } else {
                            // 좋아요 상태가 아닌 경우, 좋아요
                            likePost(postId);
                        }
                    } else {
                        alert('유효한 접근이 아닙니다');
                        location.href = 'services.html';
                    }
                });

                // 게시물 좋아요 함수
                function likePost(postId) {
                    fetch(`http://127.0.0.1:8000/api/posts/${postId}/like/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${localStorage.getItem(
                                'access'
                            )}`,
                        },
                        body: JSON.stringify({ post: postId }),
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then((data) => {
                            console.log('좋아요 처리 성공:', data);
                            if (data.like_count === 0) {
                                isLiked = false;
                            } else {
                                isLiked = true;
                            }
                            updateLikeCount(data.like_count);
                        })
                        .catch((error) => {
                            console.error('좋아요 처리 실패:', error);
                            // 오류 처리 코드를 추가해야 합니다.
                        });
                }

                // 게시물 좋아요 취소 함수
                function unlikePost(postId) {
                    fetch(`http://127.0.0.1:8000/api/posts/${postId}/unlike/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${localStorage.getItem(
                                'access'
                            )}`,
                        },
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then((data) => {
                            console.log('좋아요 취소 성공:', data);
                            isLiked = false;
                            updateLikeCount(data.like_count);
                        })
                        .catch((error) => {
                            console.error('좋아요 취소 실패:', error);
                            // 오류 처리 코드를 추가해야 합니다.
                        });
                }

                // 좋아요 수 업데이트 함수
                function updateLikeCount(likeCount) {
                    const likeCountEl = document.getElementById('like-count');
                    likeCountEl.textContent = likeCount;
                }

                // 댓글 작성 함수
                function createComment(postId, content) {
                    const requestBody = {
                        post: postId,
                        content: content,
                    };

                    fetch(
                        `http://127.0.0.1:8000/api/posts/${postId}/comments/create/`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${localStorage.getItem(
                                    'access'
                                )}`,
                            },
                            body: JSON.stringify(requestBody),
                        }
                    )
                        .then((response) => response.json())
                        .then((data) => {
                            console.log('댓글 작성 성공:', data);
                            fetchComments(postId); // 댓글 목록 새로고침
                        })
                        .catch((error) => {
                            console.error('댓글 작성 실패:', error);
                            // 오류 처리 코드를 추가해야 합니다.
                        });
                }
                // 댓글 조회 함수
                function fetchComments(postId) {
                    fetch(
                        `http://127.0.0.1:8000/api/posts/${postId}/comments/`,
                        {
                            headers: {
                                Authorization: `Bearer ${localStorage.getItem(
                                    'access'
                                )}`,
                            },
                        }
                    )
                        .then((response) => response.json())
                        .then((data) => {
                            const commentsListEl =
                                document.getElementById('commentsList');
                            commentsListEl.innerHTML = ''; // 기존 댓글 목록 초기화

                            data.forEach((comment) => {
                                const commentEl = document.createElement('div');
                                const defaultAvatarUrl =
                                    'https://picsum.photos/50/50'; // 대체 이미지 URL 예시
                                const avatarUrl =
                                    comment.get_avatar_url || defaultAvatarUrl;
                                commentEl.innerHTML = `
                                        <div>
                                        <img src="${avatarUrl}" alt="Avatar" class="rounded-circle" width="50" height="50">
                                        <strong>${
                                            comment.author_username
                                        }</strong>
                                        <span>${new Date(
                                            comment.created_at
                                        ).toLocaleString()}</span>
                                        <p>${comment.content}</p>
                                      </div>
                                      `;
                                commentsListEl.appendChild(commentEl);
                            });
                        })
                        .catch((error) => {
                            console.error('댓글 조회 실패:', error);
                        });
                }
                // 댓글 작성 폼 제출 이벤트 리스너
                commentFormEl.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const postId = getPostIdFromUrl();
                    const commentContent = commentTextareaEl.value.trim();

                    if (isAuthenticated && postId && commentContent) {
                        createComment(postId, commentContent);
                        commentTextareaEl.value = ''; // 댓글 작성 후 textarea 초기화
                    } else {
                        alert('내용을 입력해주세요');
                        location.href = 'service-details.html';
                    }
                });
                // 게시물 삭제 함수
                function deletePost(postId) {
                    fetch(`http://127.0.0.1:8000/api/posts/${postId}/delete/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${localStorage.getItem(
                                'access'
                            )}`,
                        },
                    })
                        .then((response) => {
                            if (response.ok) {
                                alert('게시물이 삭제되었습니다.');
                                location.href = 'services.html';
                            } else {
                                alert('게시물 삭제에 실패했습니다.');
                            }
                        })
                        .catch((error) => {
                            console.error('게시물 삭제 중 오류 발생:', error);
                        });
                }

                // 삭제 버튼 클릭 이벤트 리스너 추가
                const deletePostBtn =
                    document.getElementById('delete-post-btn');
                if (deletePostBtn) {
                    deletePostBtn.addEventListener('click', () => {
                        const postId = getPostIdFromUrl(); // postId를 여기서 가져옴
                        if (postId) {
                            deletePost(postId);
                        } else {
                            alert('유효한 접근이 아닙니다');
                            location.href = 'services.html';
                        }
                    });
                }
                const editPostBtn = document.getElementById('edit-post-btn');
                if (editPostBtn) {
                    editPostBtn.addEventListener('click', () => {
                        // 수정 모달 창 열기 또는 수정 폼 렌더링 등의 로직 추가
                        alert('수정 기능은 준비 중입니다.');
                        location.href = `post-update.html?postId=${postId}`;
                    });
                }
            } else {
                // 로그인 되어 있지 않은 경우
                if (loginBtnEl) {
                    loginBtnEl.style.display = 'block';
                    // 로그인 버튼에 이벤트 리스너 추가
                    loginBtnEl.addEventListener('click', () => {
                        // login.html로 리다이렉트
                        location.href = 'login.html';
                    });
                }
                if (logoutBtnEl) {
                    logoutBtnEl.style.display = 'none';
                }
            }
        });
    </script>
</html>
